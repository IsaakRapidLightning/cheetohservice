<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="/cheetoh.png" type="image/png" />
<title>CheetohService Chat</title>
<style>
  :root {
    --cheetoh-orange: #f97316;
    --cheetoh-deep: #ea580c;
    --cheetoh-light: #ffedd5;
    --bg-dark: #0f0f0f;
    --card: #18181b;
    --text: #f8fafc;
    --muted: #cbd5e1;
    --accent: #fde68a;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color: var(--text);
    background: radial-gradient(1200px 600px at 20% -20%, rgba(249,115,22,.25), transparent 60%),
                radial-gradient(1000px 800px at 120% 20%, rgba(234,88,12,.15), transparent 60%),
                var(--bg-dark);
    min-height: 100vh;
    display: grid;
    grid-template-rows: auto 1fr auto;
  }
  header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: linear-gradient(90deg, var(--cheetoh-deep), var(--cheetoh-orange));
    color: #111827;
    font-weight: 800;
    letter-spacing: .5px;
    text-transform: uppercase;
  }
  header .logo {
    width: 28px;
    height: 28px;
    background: url('/cheetoh.png') center/cover no-repeat;
    border-radius: 6px;
    box-shadow: 0 8px 24px rgba(0,0,0,.3);
  }
  main {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 16px;
    padding: 16px;
  }
  .sidebar {
    background: var(--card);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 12px;
    padding: 12px;
  }
  .admin-section { margin-top: 16px; padding-top: 12px; border-top: 1px dashed rgba(255,255,255,.08); }
  .switch {
    position: relative; display: inline-block; width: 46px; height: 24px; vertical-align: middle;
  }
  .switch input { display:none; }
  .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#374151; transition:.2s; border-radius:999px; }
  .slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:white; transition:.2s; border-radius:999px; }
  input:checked + .slider { background: linear-gradient(180deg, var(--cheetoh-orange), var(--cheetoh-deep)); }
  input:checked + .slider:before { transform: translateX(22px); }
  .panel-title {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: .1em;
    margin: 4px 0 10px;
  }
  .username-row { display: flex; gap: 8px; }
  .username-row input {
    flex: 1;
    background: #0b0b0c;
    color: var(--text);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 8px;
    padding: 8px 10px;
  }
  .btn {
    background: linear-gradient(180deg, var(--cheetoh-orange), var(--cheetoh-deep));
    color: #111827;
    border: none;
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
  }
  .content {
    display: grid;
    grid-template-rows: 1fr auto;
    gap: 12px;
  }
  .chat {
    background: var(--card);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 12px;
    padding: 12px;
    display: grid;
    grid-template-rows: 1fr;
  }
  #messages {
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 60vh;
  }
  .bubble {
    display: grid;
    gap: 4px;
    border-left: 4px solid transparent;
    background: rgba(255,255,255,.03);
    padding: 8px 10px;
    border-radius: 8px;
  }
  .bubble .meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--muted);
  }
  .bubble .text { font-size: 15px; white-space: pre-wrap; word-break: break-word; }
  .bubble .actions { display: flex; gap: 6px; }
  .linklike { background: transparent; border: none; color: var(--accent); cursor: pointer; font-size: 12px; }
  .admin-tools { display:flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
  .admin-panel {
    margin-top: 12px;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 10px;
    padding: 10px;
  }
  .user-list { display:flex; flex-direction:column; gap:8px; max-height: 200px; overflow:auto; }
  .composer {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .composer input {
    flex: 1;
    background: #0b0b0c;
    color: var(--text);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 10px;
    padding: 12px 14px;
    min-width: 400px;
  }
  .composer input:disabled { opacity: .5; cursor: not-allowed; }
  .btn:disabled { opacity: .5; cursor: not-allowed; }
  .upload-btn {
    background: linear-gradient(180deg, var(--cheetoh-orange), var(--cheetoh-deep));
    color: #111827;
    border: none;
    padding: 12px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    font-size: 16px;
    min-width: 44px;
  }
  .upload-btn:hover { opacity: 0.9; }
  .upload-btn:disabled { opacity: .5; cursor: not-allowed; }
  .file-input { display: none; }
  .command-help {
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 8px;
    padding: 8px 12px;
    margin: 4px 0;
    font-size: 13px;
    color: var(--muted);
  }
  .slash-autocomplete {
    position: absolute;
    bottom: 100%;
    left: 0;
    right: 0;
    background: var(--card);
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 4px;
    z-index: 10;
    max-height: 200px;
    overflow-y: auto;
  }
  .slash-item {
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 13px;
  }
  .slash-item:hover {
    background: rgba(255,255,255,.1);
  }
  .slash-item.selected {
    background: var(--cheetoh-orange);
    color: #111827;
  }
  .camera-stream {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: min(90vw, 640px);
    height: min(60vh, 480px);
    background: var(--card);
    border: 2px solid var(--cheetoh-orange);
    border-radius: 12px;
    z-index: 1000;
    display: none;
  }
  .camera-video {
    width: 100%;
    height: 100%;
    border-radius: 10px;
    object-fit: cover;
  }
  .camera-controls {
    position: absolute;
    bottom: 8px;
    left: 8px;
    right: 8px;
    display: flex;
    gap: 8px;
  }
  .camera-btn {
    background: rgba(0,0,0,.7);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
  }
  .typing-indicator {
    font-style: italic;
    color: var(--muted);
    font-size: 12px;
    padding: 4px 8px;
  }
  .reaction-btn {
    background: transparent;
    border: none;
    color: var(--accent);
    cursor: pointer;
    font-size: 16px;
    padding: 2px 4px;
    border-radius: 4px;
  }
  .reaction-btn:hover {
    background: rgba(255,255,255,.1);
  }
  .reactions {
    display: flex;
    gap: 4px;
    margin-top: 4px;
    flex-wrap: wrap;
  }
  .profile-picture {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--cheetoh-orange);
  }
  .profile-picture-small {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid var(--cheetoh-orange);
  }
  .profile-upload {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }
  .profile-upload input[type="file"] {
    display: none;
  }
  .profile-upload-btn {
    background: linear-gradient(180deg, var(--cheetoh-orange), var(--cheetoh-deep));
    color: #111827;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    font-size: 12px;
  }
  .storage-info {
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 8px;
    padding: 8px;
    margin-top: 8px;
    font-size: 11px;
    color: var(--muted);
  }
  .cheetoh-party {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1000;
  }
  .cheetoh-emoji {
    position: absolute;
    font-size: 24px;
    animation: cheetohFloat 3s linear infinite;
  }
  @keyframes cheetohFloat {
    0% { transform: translateY(100vh) rotate(0deg); opacity: 1; }
    100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
  }
  .message-image {
    max-width: 200px;
    max-height: 200px;
    border-radius: 8px;
    margin: 4px 0;
    cursor: pointer;
  }
  .message-audio {
    width: 100%;
    max-width: 300px;
    margin: 4px 0;
  }
  .admin-requests {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 8px;
    padding: 8px;
    margin: 8px 0;
  }
  .request-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
    margin: 4px 0;
    background: rgba(255,255,255,.03);
    border-radius: 6px;
    font-size: 12px;
  }
  .badge { padding: 2px 6px; border-radius: 6px; font-weight: 700; font-size: 11px; }
  .badge.admin { background: linear-gradient(180deg, #fde68a, #f59e0b); color: #3b2800; }
  .system { opacity: .85; font-style: italic; border-left-color: #475569 !important; }
  footer { padding: 10px 16px; color: var(--muted); font-size: 12px; }

  @media (max-width: 900px) {
    main { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<header>
  <div class="logo"></div>
  <div>CheetohService Chat</div>
  <div id="selfBadge" style="margin-left:auto" class="badge">Guest</div>
  <div id="adminBadge" class="badge admin" style="display:none; margin-left:8px;">Admin</div>
  <div style="width:8px"></div>
</header>
<main>
  <aside class="sidebar">
    <div class="panel-title">Profile</div>
    <div class="username-row">
      <input id="usernameInput" maxlength="24" placeholder="Set username" />
      <button class="btn" id="saveUsername">Save</button>
    </div>
    <div style="height:10px"></div>
    <div style="font-size:12px;color:var(--muted)">Your color is derived from your IP.</div>
    
    <div style="height:10px"></div>
    <div class="panel-title">Profile Picture</div>
    <div class="profile-upload">
      <img id="profilePicture" class="profile-picture" src="/cheetoh.png" alt="Profile" />
      <input type="file" id="profileInput" accept="image/*" />
      <button class="profile-upload-btn" id="profileUploadBtn">Upload</button>
    </div>
    
    <div class="storage-info">
      <div>📁 Files stored in: public/uploads/</div>
      <div>🗑️ Auto-cleanup: 7+ days old</div>
      <div>💾 Storage: Local PC</div>
    </div>

    <div class="admin-section" id="adminSection" style="display:none;">
      <div class="panel-title">Admin</div>
      <div class="admin-panel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div style="font-size:13px;color:var(--muted)">Family Friendly</div>
          <label class="switch"><input type="checkbox" id="familyToggle"><span class="slider"></span></label>
        </div>
        <div style="height:8px"></div>
        <div style="font-size:12px;color:var(--muted)">Temporarily ban by IP (kick):</div>
        <div class="admin-tools">
          <select id="userSelect" style="flex:1;background:#0b0b0c;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:6px 8px;"></select>
          <select id="banDuration" style="width:130px;background:#0b0b0c;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:6px 8px;">
            <option value="0">Kick only</option>
            <option value="5000">5s</option>
            <option value="15000">15s</option>
            <option value="30000">30s</option>
            <option value="60000">60s</option>
          </select>
          <button class="btn" id="kickBtn">Kick</button>
        </div>
        <div style="height:8px"></div>
        <div style="font-size:12px;color:var(--muted)">Message history:</div>
        <div class="admin-tools">
          <button class="btn" id="loadHistoryBtn">Load last 200</button>
        </div>
        <div style="height:8px"></div>
        <div style="font-size:12px;color:var(--muted)">Admin requests:</div>
        <div class="admin-tools">
          <button class="btn" id="loadRequestsBtn">Load Requests</button>
        </div>
        <div id="adminRequests" class="admin-requests"></div>
        <div style="height:8px"></div>
        <div style="font-size:12px;color:var(--muted)">Power actions:</div>
        <div class="admin-tools">
          <button class="btn" id="clearChatBtn">Clear Chat</button>
          <button class="btn" id="kickAllBtn">Kick All</button>
        </div>
        <div style="height:8px"></div>
        <div style="font-size:12px;color:var(--muted)">Announcement:</div>
        <div class="admin-tools">
          <input id="announceInput" placeholder="Announcement text" style="flex:1;background:#0b0b0c;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:6px 8px;" />
          <button class="btn" id="announceBtn">Announce</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="panel-title">Online</div>
      <div id="userList" class="user-list"></div>
    </div>
  </aside>
  <section class="content">
    <div class="chat">
<div id="messages"></div>
    </div>
    <div class="composer">
      <div style="position: relative; flex: 1;">
<input id="messageInput" autocomplete="off" placeholder="Type your message..."/>
        <div id="slashAutocomplete" class="slash-autocomplete" style="display: none;"></div>
      </div>
      <button class="upload-btn" id="uploadBtn" title="Upload file">+</button>
      <input type="file" id="fileInput" class="file-input" accept="image/*,audio/*" />
      <button class="btn" id="sendBtn">Send</button>
    </div>
  </section>
</main>
<footer></footer>

<!-- Camera stream overlay -->
<div id="cameraStream" class="camera-stream">
  <video id="cameraVideo" class="camera-video" autoplay muted></video>
  <div class="camera-controls">
    <button class="camera-btn" id="stopCamera">Stop Camera</button>
    <button class="camera-btn" id="toggleMic">Mic On</button>
  </div>
</div>
<div id="gate" style="position:fixed;inset:0;background:rgba(0,0,0,.88);display:flex;align-items:center;justify-content:center;z-index:50;">
  <div style="width:min(96%,480px);background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.6);">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--cheetoh-light)">
      <div class="logo"></div>
      Welcome to CheetohService
    </div>
    <div style="color:var(--muted);font-size:14px;margin-bottom:12px;">Choose a username to enter the chat.</div>
    <div style="display:flex;gap:8px;">
      <input id="gateUsername" maxlength="24" placeholder="Your username" style="flex:1;background:#0b0b0c;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px 14px;" />
      <button class="btn" id="enterBtn">Enter</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const messagesEl = document.getElementById('messages');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const usernameInput = document.getElementById('usernameInput');
  const saveUsername = document.getElementById('saveUsername');
  const selfBadge = document.getElementById('selfBadge');
  const adminBadge = document.getElementById('adminBadge');
  // admin refs
  const adminSection = document.getElementById('adminSection');
  const familyToggle = document.getElementById('familyToggle');
  const userSelect = document.getElementById('userSelect');
  const userList = document.getElementById('userList');
  const banDuration = document.getElementById('banDuration');
  const kickBtn = document.getElementById('kickBtn');
  const loadHistoryBtn = document.getElementById('loadHistoryBtn');
  const loadRequestsBtn = document.getElementById('loadRequestsBtn');
  const adminRequests = document.getElementById('adminRequests');
  const clearChatBtn = document.getElementById('clearChatBtn');
  const kickAllBtn = document.getElementById('kickAllBtn');
  const announceInput = document.getElementById('announceInput');
  const announceBtn = document.getElementById('announceBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('fileInput');
  const slashAutocomplete = document.getElementById('slashAutocomplete');
  const cameraStream = document.getElementById('cameraStream');
  const cameraVideo = document.getElementById('cameraVideo');
  const stopCamera = document.getElementById('stopCamera');
  const toggleMic = document.getElementById('toggleMic');
  const profilePicture = document.getElementById('profilePicture');
  const profileInput = document.getElementById('profileInput');
  const profileUploadBtn = document.getElementById('profileUploadBtn');

  let selfUser = { id: null, username: 'Guest', color: '#fff', isAdmin: false, profilePicture: null };
  let gateActive = true;
  let currentStream = null;
  let micEnabled = true;
  let autocompleteIndex = -1;

  function setSelf(user){
    selfUser = { ...selfUser, ...user };
    selfBadge.textContent = selfUser.username;
    selfBadge.style.background = selfUser.color;
    selfBadge.style.color = '#111827';
    adminBadge.style.display = selfUser.isAdmin ? 'inline-block' : 'none';
    if(user.profilePicture && profilePicture) {
      profilePicture.src = user.profilePicture;
    }
  }

  function createMessageEl(message){
    const wrapper = document.createElement('div');
    wrapper.className = 'bubble' + (message.system ? ' system' : '');
    wrapper.dataset.id = message.id;
    wrapper.style.borderLeftColor = message.color || 'transparent';

    const meta = document.createElement('div');
    meta.className = 'meta';
    
    // Profile picture
    if(message.profilePicture) {
      const profileImg = document.createElement('img');
      profileImg.src = message.profilePicture;
      profileImg.className = 'profile-picture-small';
      meta.appendChild(profileImg);
    }
    
    const name = document.createElement('span');
    name.textContent = message.username;
    name.style.color = message.color || 'var(--muted)';
    const time = document.createElement('span');
    const dt = new Date(message.timestamp || Date.now());
    time.textContent = '• ' + dt.toLocaleTimeString();
    meta.appendChild(name);
    if(message.userId === selfUser.id){
      const me = document.createElement('span');
      me.textContent = '(you)';
      me.style.opacity = .7;
      meta.appendChild(me);
    }
    if(!message.system && message.isAdmin){
      const badge = document.createElement('span');
      badge.className = 'badge admin';
      badge.textContent = 'admin';
      meta.appendChild(badge);
    }
    meta.appendChild(time);

    const text = document.createElement('div');
    text.className = 'text';
    text.textContent = message.text;

    const actions = document.createElement('div');
    actions.className = 'actions';
    if(!message.system && (selfUser.isAdmin || message.userId === selfUser.id)){
      const editBtn = document.createElement('button');
      editBtn.className = 'linklike';
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => beginEdit(wrapper, message);
      const delBtn = document.createElement('button');
      delBtn.className = 'linklike';
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => deleteMessage(message.id);
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      if(selfUser.isAdmin){
        const censorBtn = document.createElement('button');
        censorBtn.className = 'linklike';
        censorBtn.textContent = 'Censor';
        censorBtn.onclick = () => socket.emit('admin:censor_message', { id: message.id });
        actions.appendChild(censorBtn);
      }
    }

    wrapper.appendChild(meta);
    wrapper.appendChild(text);
    
    // Handle special message types
    if(message.type === 'picture' && message.pictureUrl){
      const img = document.createElement('img');
      img.src = message.pictureUrl;
      img.className = 'message-image';
      img.onclick = () => window.open(message.pictureUrl, '_blank');
      wrapper.appendChild(img);
    }
    
    if(message.type === 'file' && message.fileUrl){
      if(message.fileType === 'image'){
        const img = document.createElement('img');
        img.src = message.fileUrl;
        img.className = 'message-image';
        img.onclick = () => window.open(message.fileUrl, '_blank');
        wrapper.appendChild(img);
      } else if(message.fileType === 'audio'){
        const audio = document.createElement('audio');
        audio.src = message.fileUrl;
        audio.controls = true;
        audio.className = 'message-audio';
        wrapper.appendChild(audio);
      }
    }
    
    if(actions.childNodes.length) wrapper.appendChild(actions);
    return wrapper;
  }

  function renderAll(msgs){
    messagesEl.innerHTML = '';
    msgs.forEach(m => messagesEl.appendChild(createMessageEl(m)));
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function appendOne(m){
    messagesEl.appendChild(createMessageEl(m));
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function beginEdit(wrapper, message){
    const textEl = wrapper.querySelector('.text');
    const original = message.text;
    const input = document.createElement('input');
    input.value = original;
    input.style.width = '100%';
    input.onkeydown = (e) => {
      if(e.key === 'Enter') finish();
      if(e.key === 'Escape') cancel();
    };
    textEl.replaceWith(input);
    input.focus();

    function finish(){
      const newText = input.value.trim();
      if(!newText) return cancel();
      socket.emit('chat:edit', { id: message.id, newText });
    }
    function cancel(){
      input.replaceWith(textEl);
    }
  }

  function deleteMessage(id){
    socket.emit('chat:delete', { id });
  }

  function sendMessage(){
    if(gateActive) return;
    const val = input.value.trim();
    if(!val) return;
    socket.emit('chat:send', val);
    input.value = '';
  }
  // gate controls
  const gate = document.getElementById('gate');
  const gateUsername = document.getElementById('gateUsername');
  const enterBtn = document.getElementById('enterBtn');
  function enterChat(){
    const name = (gateUsername.value || '').trim();
    if(!name) return;
    socket.emit('user:set_username', name);
    gate.style.display = 'none';
    gateActive = false;
    input.disabled = false;
    sendBtn.disabled = false;
    uploadBtn.disabled = false;
  }
  enterBtn.onclick = enterChat;
  gateUsername.addEventListener('keypress', e => { if(e.key === 'Enter') enterChat(); });

  // initially disable composer until name is set
  input.disabled = true;
  sendBtn.disabled = true;
  uploadBtn.disabled = true;

  socket.on('sys:kicked', ({ reason }) => {
    alert(reason || 'Kicked');
  });
  
  // Global functions for admin actions
  window.grantAdmin = (userId) => {
    socket.emit('admin:grant_admin', { userId });
  };
  window.denyAdmin = (userId) => {
    socket.emit('admin:deny_admin', { userId });
  };
  
  // Slash autocomplete functions
  function showSlashAutocomplete(value) {
    const commands = ['/help', '/picture', '/cheetohparty', '/requestadmin', '/grant', '/camera', '/slash'];
    const filtered = commands.filter(cmd => cmd.toLowerCase().startsWith(value.toLowerCase()));
    
    if(filtered.length === 0) {
      slashAutocomplete.style.display = 'none';
      return;
    }
    
    slashAutocomplete.innerHTML = '';
    filtered.forEach((cmd, index) => {
    const item = document.createElement('div');
      item.className = 'slash-item';
      item.textContent = cmd;
      item.onclick = () => {
        input.value = cmd + ' ';
        slashAutocomplete.style.display = 'none';
        input.focus();
      };
      slashAutocomplete.appendChild(item);
    });
    
    slashAutocomplete.style.display = 'block';
    autocompleteIndex = 0;
    updateAutocompleteSelection();
  }
  
  function navigateAutocomplete(direction) {
    if(slashAutocomplete.style.display === 'none') return;
    const items = slashAutocomplete.querySelectorAll('.slash-item');
    if(items.length === 0) return;
    
    autocompleteIndex += direction;
    if(autocompleteIndex < 0) autocompleteIndex = items.length - 1;
    if(autocompleteIndex >= items.length) autocompleteIndex = 0;
    
    updateAutocompleteSelection();
  }
  
  function updateAutocompleteSelection() {
    const items = slashAutocomplete.querySelectorAll('.slash-item');
    items.forEach((item, index) => {
      item.classList.toggle('selected', index === autocompleteIndex);
    });
  }
  
  function selectAutocomplete() {
    const items = slashAutocomplete.querySelectorAll('.slash-item');
    if(autocompleteIndex >= 0 && autocompleteIndex < items.length) {
      input.value = items[autocompleteIndex].textContent + ' ';
      slashAutocomplete.style.display = 'none';
      autocompleteIndex = -1;
      input.focus();
    }
  }
  
  // Camera streaming functions
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: true, 
        audio: true 
      });
      currentStream = stream;
      cameraVideo.srcObject = stream;
      cameraStream.style.display = 'block';
      micEnabled = true;
      toggleMic.textContent = 'Mic On';
    } catch(err) {
      alert('Camera access denied: ' + err.message);
    }
  }
  
  // Cheetoh party effect
  function startCheetohParty(duration) {
    const partyDiv = document.createElement('div');
    partyDiv.className = 'cheetoh-party';
    document.body.appendChild(partyDiv);
    
    const interval = setInterval(() => {
      const cheetoh = document.createElement('div');
      cheetoh.className = 'cheetoh-emoji';
      cheetoh.textContent = '🐆';
      cheetoh.style.left = Math.random() * 100 + '%';
      cheetoh.style.animationDelay = Math.random() * 2 + 's';
      partyDiv.appendChild(cheetoh);
      
      setTimeout(() => cheetoh.remove(), 3000);
    }, 200);
    
    setTimeout(() => {
      clearInterval(interval);
      partyDiv.remove();
    }, duration);
  }

  sendBtn.onclick = sendMessage;
  input.addEventListener('keydown', e => { 
    if(e.key === 'Enter') {
      if(slashAutocomplete.style.display !== 'none' && autocompleteIndex >= 0) {
        e.preventDefault();
        selectAutocomplete();
      } else {
        sendMessage();
      }
    }
    if(e.key === 'Tab') {
      if(slashAutocomplete.style.display !== 'none' && autocompleteIndex >= 0) {
        e.preventDefault();
        selectAutocomplete();
      }
    }
    if(e.key === 'Escape') {
      slashAutocomplete.style.display = 'none';
      autocompleteIndex = -1;
    }
    if(e.key === 'ArrowDown') {
      e.preventDefault();
      navigateAutocomplete(1);
    }
    if(e.key === 'ArrowUp') {
      e.preventDefault();
      navigateAutocomplete(-1);
    }
  });
  
  input.addEventListener('input', (e) => {
    const value = e.target.value;
    if(value.startsWith('/') && value.length > 1) {
      showSlashAutocomplete(value);
    } else {
      slashAutocomplete.style.display = 'none';
      autocompleteIndex = -1;
    }
  });
  
  saveUsername.onclick = () => {
    const val = usernameInput.value.trim();
    if(!val) return;
    socket.emit('user:set_username', val);
  };
  
  // Camera controls
  stopCamera?.addEventListener('click', () => {
    if(currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      currentStream = null;
    }
    cameraStream.style.display = 'none';
    socket.emit('camera:stop');
  });
  
  toggleMic?.addEventListener('click', () => {
    micEnabled = !micEnabled;
    if(currentStream) {
      currentStream.getAudioTracks().forEach(track => {
        track.enabled = micEnabled;
      });
    }
    toggleMic.textContent = micEnabled ? 'Mic On' : 'Mic Off';
  });
  
  // Profile picture upload
  profileUploadBtn?.addEventListener('click', () => {
    profileInput.click();
  });
  
  profileInput?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    const formData = new FormData();
    formData.append('profile', file);
    
    fetch('/upload-profile', {
      method: 'POST',
      body: formData
    })
    .then(async (res) => {
      const contentType = res.headers.get('content-type') || '';
      if(!res.ok) {
        if(contentType.includes('application/json')){
          const data = await res.json();
          throw new Error(data.error || 'Upload failed');
        } else {
          const text = await res.text();
          throw new Error('Upload failed: ' + text.slice(0, 120));
        }
      }
      if(!contentType.includes('application/json')){
        const text = await res.text();
        throw new Error('Unexpected response: ' + text.slice(0, 120));
      }
      return res.json();
    })
    .then(data => {
      if(data.success) {
        profilePicture.src = data.url;
        socket.emit('profile:set_picture', { url: data.url });
      } else {
        alert('Upload failed: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(err => {
      alert('Upload failed: ' + err.message);
    });
    
    profileInput.value = '';
  });

  // admin UI actions
  familyToggle?.addEventListener('change', () => {
    socket.emit('admin:set_family_friendly', familyToggle.checked);
  });
  kickBtn?.addEventListener('click', () => {
    const userId = userSelect.value;
    const durationMs = Number(banDuration.value || 0);
    if(userId) socket.emit('admin:kick', { userId, durationMs });
  });
  loadHistoryBtn?.addEventListener('click', () => {
    socket.emit('admin:get_history', { limit: 200 });
  });
  loadRequestsBtn?.addEventListener('click', () => {
    socket.emit('admin:get_requests');
  });
  clearChatBtn?.addEventListener('click', () => {
    if(confirm('Clear all chat messages?')) {
      socket.emit('admin:clear_chat');
    }
  });
  kickAllBtn?.addEventListener('click', () => {
    if(confirm('Kick all users?')) {
      socket.emit('admin:kick_all');
    }
  });
  announceBtn?.addEventListener('click', () => {
    const text = announceInput.value.trim();
    if(text) {
      socket.emit('admin:announce', { text });
      announceInput.value = '';
    }
  });
  announceInput?.addEventListener('keypress', (e) => {
    if(e.key === 'Enter') announceBtn.click();
  });
  
  // File upload
  uploadBtn?.addEventListener('click', () => {
    if(gateActive) return;
    fileInput.click();
  });
  fileInput?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    // Check file size (1 minute audio limit)
    if(file.type.startsWith('audio/') && file.size > 10 * 1024 * 1024) {
      alert('Audio files must be under 10MB (approximately 1 minute)');
      return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/upload', {
      method: 'POST',
      body: formData
    })
    .then(async (res) => {
      const contentType = res.headers.get('content-type') || '';
      if(!res.ok) {
        if(contentType.includes('application/json')){
          const data = await res.json();
          throw new Error(data.error || 'Upload failed');
        } else {
          const text = await res.text();
          throw new Error('Upload failed: ' + text.slice(0, 120));
        }
      }
      if(!contentType.includes('application/json')){
        const text = await res.text();
        throw new Error('Unexpected response: ' + text.slice(0, 120));
      }
      return res.json();
    })
    .then(data => {
      if(data.success) {
        socket.emit('chat:send_file', {
          url: data.url,
          type: data.type,
          filename: data.filename
        });
      } else {
        alert('Upload failed: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(err => {
      alert('Upload failed: ' + err.message);
    });
    
    fileInput.value = '';
  });

  function refreshPresence(users){
    // dropdown
    if(userSelect){
      userSelect.innerHTML = '';
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id; opt.textContent = u.username; opt.style.color = u.color;
        userSelect.appendChild(opt);
      });
    }
    // list
    if(userList){
      userList.innerHTML = '';
      users.forEach(u => addPresenceEntry(u));
    }
  }
  function addOrUpdatePresence(u){
    if(userSelect){
      const opt = [...userSelect.options].find(o => o.value === u.id);
      if(!opt){
        const n = document.createElement('option'); n.value = u.id; n.textContent = u.username; n.style.color = u.color; userSelect.appendChild(n);
      } else {
        opt.textContent = u.username; opt.style.color = u.color;
      }
    }
    addPresenceEntry(u);
  }
  function addPresenceEntry(u){
    if(!userList) return;
    let row = userList.querySelector(`[data-id="${u.id}"]`);
    if(!row){
      row = document.createElement('div');
      row.dataset.id = u.id;
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.justifyContent = 'space-between';
      row.style.gap = '8px';
      row.style.padding = '6px 8px';
      row.style.border = '1px solid rgba(255,255,255,.06)';
      row.style.borderRadius = '8px';
      userList.appendChild(row);
    }
    row.innerHTML = '';
    const left = document.createElement('div');
    left.style.display = 'flex';
    left.style.alignItems = 'center';
    left.style.gap = '8px';
    const swatch = document.createElement('div'); swatch.style.width='10px'; swatch.style.height='10px'; swatch.style.borderRadius='999px'; swatch.style.background=u.color;
    
    // Profile picture if available
    if(u.profilePicture) {
      const profileImg = document.createElement('img');
      profileImg.src = u.profilePicture;
      profileImg.className = 'profile-picture-small';
      left.appendChild(profileImg);
    } else {
      left.appendChild(swatch);
    }
    
    const name = document.createElement('div'); name.textContent = u.username; name.style.fontSize = '13px';
    if(u.isAdmin){ const b = document.createElement('span'); b.className='badge admin'; b.textContent='admin'; name.appendChild(b); }
    left.appendChild(name);
    const right = document.createElement('div');
    const kick = document.createElement('button'); kick.className='linklike'; kick.textContent='Kick'; kick.onclick = () => { if(userSelect){ userSelect.value = u.id; } if(kickBtn){ kickBtn.click(); } };
    right.appendChild(kick);
    row.appendChild(left); row.appendChild(right);
  }
  function removePresence(id){
    if(userSelect){
      const opt = [...userSelect.options].find(o => o.value === id);
      if(opt) opt.remove();
    }
    if(userList){
      const row = userList.querySelector(`[data-id="${id}"]`);
      if(row) row.remove();
    }
  }

  // socket events
  socket.on('init', (payload) => {
    setSelf(payload.self);
    usernameInput.value = payload.self.username || '';
    renderAll(payload.messages || []);
    // admin and presence state
    if(adminSection) adminSection.style.display = payload.self.isAdmin ? 'block' : 'none';
    if(familyToggle) familyToggle.checked = !!payload.familyFriendly;
    if(payload.users) refreshPresence(payload.users);
  });
  socket.on('user:update_self', (payload) => {
    setSelf(payload);
    if(adminSection) adminSection.style.display = payload.isAdmin ? 'block' : 'none';
  });
  socket.on('chat:new', (m) => {
    appendOne(m);
  });
  socket.on('chat:edited', ({ id, text, editedAt }) => {
    const node = [...messagesEl.children].find(n => n.dataset.id === id);
    if(!node) return;
    const textEl = node.querySelector('.text');
    if(textEl){ textEl.textContent = text; }
    const meta = node.querySelector('.meta');
    if(meta){
      const tag = document.createElement('span');
      tag.textContent = ' (edited)';
      tag.style.opacity = .7;
      meta.appendChild(tag);
    }
  });
  socket.on('chat:deleted', ({ id }) => {
    const node = [...messagesEl.children].find(n => n.dataset.id === id);
    if(node) node.remove();
  });
  socket.on('presence:join', (u) => addOrUpdatePresence(u));
  socket.on('presence:update', (u) => addOrUpdatePresence(u));
  socket.on('presence:leave', ({ id }) => removePresence(id));
  socket.on('admin:family_friendly', ({ enabled }) => { if(familyToggle) familyToggle.checked = !!enabled; });
  socket.on('admin:history', (arr) => {
    messagesEl.innerHTML = '';
    renderAll(arr);
  });
  socket.on('command:result', (result) => {
    if(result.type === 'help') {
      const helpDiv = document.createElement('div');
      helpDiv.className = 'command-help';
      helpDiv.textContent = result.text;
      messagesEl.appendChild(helpDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    } else if(result.type === 'slash') {
      const slashDiv = document.createElement('div');
      slashDiv.className = 'command-help';
      slashDiv.textContent = 'Available commands: ' + result.commands.join(', ');
      messagesEl.appendChild(slashDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    } else if(result.type === 'requestadmin') {
      const reqDiv = document.createElement('div');
      reqDiv.className = 'command-help';
      reqDiv.textContent = result.text;
      messagesEl.appendChild(reqDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    } else if(result.type === 'success') {
      const successDiv = document.createElement('div');
      successDiv.className = 'command-help';
      successDiv.style.color = '#10b981';
      successDiv.textContent = result.text;
      messagesEl.appendChild(successDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    } else if(result.type === 'error') {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'command-help';
      errorDiv.style.color = '#ef4444';
      errorDiv.textContent = result.text;
      messagesEl.appendChild(errorDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  });
  
  socket.on('command:camera', ({ userId, username, action }) => {
    if(action === 'enable' && userId === selfUser.id) {
      startCamera();
    }
  });
  
  socket.on('admin:request', ({ userId, username, reason }) => {
    if(!selfUser.isAdmin) return;
    const reqDiv = document.createElement('div');
    reqDiv.className = 'command-help';
    reqDiv.innerHTML = `Admin request from ${username}: ${reason} <button class='linklike' onclick='grantAdmin("${userId}")'>Grant</button> <button class='linklike' onclick='denyAdmin("${userId}")'>Deny</button>`;
    messagesEl.appendChild(reqDiv);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });
  
  socket.on('admin:requests', (requests) => {
    if(!adminRequests) return;
    adminRequests.innerHTML = '';
    requests.forEach(req => {
      const item = document.createElement('div');
      item.className = 'request-item';
      item.innerHTML = `
        <div>${req.username}: ${req.reason}</div>
        <div>
          <button class='linklike' onclick='grantAdmin("${req.userId}")'>Grant</button>
          <button class='linklike' onclick='denyAdmin("${req.userId}")'>Deny</button>
        </div>
      `;
      adminRequests.appendChild(item);
    });
  });
  
  socket.on('admin:chat_cleared', () => {
    messagesEl.innerHTML = '';
  });
  
  socket.on('chat:file_uploaded', (data) => {
    const message = {
      id: 'file_' + Date.now(),
      text: `${data.username} shared a ${data.fileType}`,
      username: data.username,
      color: data.color,
      userId: data.userId,
      isAdmin: data.isAdmin,
      timestamp: Date.now(),
      type: 'file',
      fileUrl: data.url,
      fileType: data.type
    };
    appendOne(message);
  });
</script>
</body>
</html>
