<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="/cheetoh.png" type="image/png" />
<title>CheetohService Chat</title>
<style>
  :root {
    --cheetoh-orange: #f97316;
    --cheetoh-deep: #ea580c;
    --cheetoh-light: #ffedd5;
    --bg-dark: #0f0f0f;
    --card: #18181b;
    --text: #f8fafc;
    --muted: #cbd5e1;
    --accent: #fde68a;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color: var(--text);
    background: radial-gradient(1200px 600px at 20% -20%, rgba(249,115,22,.25), transparent 60%),
                radial-gradient(1000px 800px at 120% 20%, rgba(234,88,12,.15), transparent 60%),
                var(--bg-dark);
    min-height: 100vh;
    display: grid;
    grid-template-rows: auto 1fr auto;
  }
  header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: linear-gradient(90deg, var(--cheetoh-deep), var(--cheetoh-orange));
    color: #111827;
    font-weight: 800;
    letter-spacing: .5px;
    text-transform: uppercase;
  }
  header .logo {
    width: 28px;
    height: 28px;
    background: url('/cheetoh.png') center/cover no-repeat;
    border-radius: 6px;
    box-shadow: 0 8px 24px rgba(0,0,0,.3);
  }
  main {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 16px;
    padding: 16px;
  }
  .sidebar {
    background: var(--card);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 12px;
    padding: 12px;
  }
  .admin-section { margin-top: 16px; padding-top: 12px; border-top: 1px dashed rgba(255,255,255,.08); }
  .switch {
    position: relative; display: inline-block; width: 46px; height: 24px; vertical-align: middle;
  }
  .switch input { display:none; }
  .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#374151; transition:.2s; border-radius:999px; }
  .slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:white; transition:.2s; border-radius:999px; }
  input:checked + .slider { background: linear-gradient(180deg, var(--cheetoh-orange), var(--cheetoh-deep)); }
  input:checked + .slider:before { transform: translateX(22px); }
  .panel-title {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: .1em;
    margin: 4px 0 10px;
  }
  .username-row { display: flex; gap: 8px; }
  .username-row input {
    flex: 1;
    background: #0b0b0c;
    color: var(--text);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 8px;
    padding: 8px 10px;
  }
  .btn {
    background: linear-gradient(180deg, var(--cheetoh-orange), var(--cheetoh-deep));
    color: #111827;
    border: none;
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
  }
  .content {
    display: grid;
    grid-template-rows: 1fr auto;
    gap: 12px;
  }
  .chat {
    background: var(--card);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 12px;
    padding: 12px;
    display: grid;
    grid-template-rows: 1fr;
  }
  #messages {
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 60vh;
  }
  .bubble {
    display: grid;
    gap: 4px;
    border-left: 4px solid transparent;
    background: rgba(255,255,255,.03);
    padding: 8px 10px;
    border-radius: 8px;
  }
  .bubble .meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--muted);
  }
  .bubble .text { font-size: 15px; white-space: pre-wrap; word-break: break-word; }
  .bubble .actions { display: flex; gap: 6px; }
  .linklike { background: transparent; border: none; color: var(--accent); cursor: pointer; font-size: 12px; }
  .admin-tools { display:flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
  .admin-panel {
    margin-top: 12px;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 10px;
    padding: 10px;
  }
  .user-list { display:flex; flex-direction:column; gap:8px; max-height: 200px; overflow:auto; }
  .composer {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .composer input {
    flex: 1;
    background: #0b0b0c;
    color: var(--text);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 10px;
    padding: 12px 14px;
  }
  .composer input:disabled { opacity: .5; cursor: not-allowed; }
  .btn:disabled { opacity: .5; cursor: not-allowed; }
  .badge { padding: 2px 6px; border-radius: 6px; font-weight: 700; font-size: 11px; }
  .badge.admin { background: linear-gradient(180deg, #fde68a, #f59e0b); color: #3b2800; }
  .system { opacity: .85; font-style: italic; border-left-color: #475569 !important; }
  footer { padding: 10px 16px; color: var(--muted); font-size: 12px; }

  @media (max-width: 900px) {
    main { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<header>
  <div class="logo"></div>
  <div>CheetohService Chat</div>
  <div id="selfBadge" style="margin-left:auto" class="badge">Guest</div>
  <div id="adminBadge" class="badge admin" style="display:none; margin-left:8px;">Admin</div>
  <div style="width:8px"></div>
</header>
<main>
  <aside class="sidebar">
    <div class="panel-title">Profile</div>
    <div class="username-row">
      <input id="usernameInput" maxlength="24" placeholder="Set username" />
      <button class="btn" id="saveUsername">Save</button>
    </div>
    <div style="height:10px"></div>
    <div style="font-size:12px;color:var(--muted)">Your color is derived from your IP.</div>

    <div class="admin-section" id="adminSection" style="display:none;">
      <div class="panel-title">Admin</div>
      <div class="admin-panel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div style="font-size:13px;color:var(--muted)">Family Friendly</div>
          <label class="switch"><input type="checkbox" id="familyToggle"><span class="slider"></span></label>
        </div>
        <div style="height:8px"></div>
        <div style="font-size:12px;color:var(--muted)">Temporarily ban by IP (kick):</div>
        <div class="admin-tools">
          <select id="userSelect" style="flex:1;background:#0b0b0c;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:6px 8px;"></select>
          <select id="banDuration" style="width:130px;background:#0b0b0c;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:6px 8px;">
            <option value="0">Kick only</option>
            <option value="5000">5s</option>
            <option value="15000">15s</option>
            <option value="30000">30s</option>
            <option value="60000">60s</option>
          </select>
          <button class="btn" id="kickBtn">Kick</button>
        </div>
        <div style="height:8px"></div>
        <div style="font-size:12px;color:var(--muted)">Message history:</div>
        <div class="admin-tools">
          <button class="btn" id="loadHistoryBtn">Load last 200</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="panel-title">Online</div>
      <div id="userList" class="user-list"></div>
    </div>
  </aside>
  <section class="content">
    <div class="chat">
<div id="messages"></div>
    </div>
    <div class="composer">
<input id="messageInput" autocomplete="off" placeholder="Type your message..."/>
      <button class="btn" id="sendBtn">Send</button>
    </div>
  </section>
</main>
<footer></footer>

<!-- Username gate overlay -->
<div id="gate" style="position:fixed;inset:0;background:rgba(0,0,0,.88);display:flex;align-items:center;justify-content:center;z-index:50;">
  <div style="width:min(96%,480px);background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.6);">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--cheetoh-light)">
      <div class="logo"></div>
      Welcome to CheetohService
    </div>
    <div style="color:var(--muted);font-size:14px;margin-bottom:12px;">Choose a username to enter the chat.</div>
    <div style="display:flex;gap:8px;">
      <input id="gateUsername" maxlength="24" placeholder="Your username" style="flex:1;background:#0b0b0c;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px 14px;" />
      <button class="btn" id="enterBtn">Enter</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const messagesEl = document.getElementById('messages');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const usernameInput = document.getElementById('usernameInput');
  const saveUsername = document.getElementById('saveUsername');
  const selfBadge = document.getElementById('selfBadge');
  const adminBadge = document.getElementById('adminBadge');
  // admin refs
  const adminSection = document.getElementById('adminSection');
  const familyToggle = document.getElementById('familyToggle');
  const userSelect = document.getElementById('userSelect');
  const userList = document.getElementById('userList');
  const banDuration = document.getElementById('banDuration');
  const kickBtn = document.getElementById('kickBtn');
  const loadHistoryBtn = document.getElementById('loadHistoryBtn');

  let selfUser = { id: null, username: 'Guest', color: '#fff', isAdmin: false };
  let gateActive = true;

  function setSelf(user){
    selfUser = { ...selfUser, ...user };
    selfBadge.textContent = selfUser.username;
    selfBadge.style.background = selfUser.color;
    selfBadge.style.color = '#111827';
    adminBadge.style.display = selfUser.isAdmin ? 'inline-block' : 'none';
  }

  function createMessageEl(message){
    const wrapper = document.createElement('div');
    wrapper.className = 'bubble' + (message.system ? ' system' : '');
    wrapper.dataset.id = message.id;
    wrapper.style.borderLeftColor = message.color || 'transparent';

    const meta = document.createElement('div');
    meta.className = 'meta';
    const name = document.createElement('span');
    name.textContent = message.username;
    name.style.color = message.color || 'var(--muted)';
    const time = document.createElement('span');
    const dt = new Date(message.timestamp || Date.now());
    time.textContent = 'â€¢ ' + dt.toLocaleTimeString();
    meta.appendChild(name);
    if(message.userId === selfUser.id){
      const me = document.createElement('span');
      me.textContent = '(you)';
      me.style.opacity = .7;
      meta.appendChild(me);
    }
    if(!message.system && message.isAdmin){
      const badge = document.createElement('span');
      badge.className = 'badge admin';
      badge.textContent = 'admin';
      meta.appendChild(badge);
    }
    meta.appendChild(time);

    const text = document.createElement('div');
    text.className = 'text';
    text.textContent = message.text;

    const actions = document.createElement('div');
    actions.className = 'actions';
    if(!message.system && (selfUser.isAdmin || message.userId === selfUser.id)){
      const editBtn = document.createElement('button');
      editBtn.className = 'linklike';
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => beginEdit(wrapper, message);
      const delBtn = document.createElement('button');
      delBtn.className = 'linklike';
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => deleteMessage(message.id);
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      if(selfUser.isAdmin){
        const censorBtn = document.createElement('button');
        censorBtn.className = 'linklike';
        censorBtn.textContent = 'Censor';
        censorBtn.onclick = () => socket.emit('admin:censor_message', { id: message.id });
        actions.appendChild(censorBtn);
      }
    }

    wrapper.appendChild(meta);
    wrapper.appendChild(text);
    if(actions.childNodes.length) wrapper.appendChild(actions);
    return wrapper;
  }

  function renderAll(msgs){
    messagesEl.innerHTML = '';
    msgs.forEach(m => messagesEl.appendChild(createMessageEl(m)));
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function appendOne(m){
    messagesEl.appendChild(createMessageEl(m));
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function beginEdit(wrapper, message){
    const textEl = wrapper.querySelector('.text');
    const original = message.text;
    const input = document.createElement('input');
    input.value = original;
    input.style.width = '100%';
    input.onkeydown = (e) => {
      if(e.key === 'Enter') finish();
      if(e.key === 'Escape') cancel();
    };
    textEl.replaceWith(input);
    input.focus();

    function finish(){
      const newText = input.value.trim();
      if(!newText) return cancel();
      socket.emit('chat:edit', { id: message.id, newText });
    }
    function cancel(){
      input.replaceWith(textEl);
    }
  }

  function deleteMessage(id){
    socket.emit('chat:delete', { id });
  }

  function sendMessage(){
    if(gateActive) return;
    const val = input.value.trim();
    if(!val) return;
    socket.emit('chat:send', val);
    input.value = '';
  }
  // gate controls
  const gate = document.getElementById('gate');
  const gateUsername = document.getElementById('gateUsername');
  const enterBtn = document.getElementById('enterBtn');
  function enterChat(){
    const name = (gateUsername.value || '').trim();
    if(!name) return;
    socket.emit('user:set_username', name);
    gate.style.display = 'none';
    gateActive = false;
    input.disabled = false;
    sendBtn.disabled = false;
  }
  enterBtn.onclick = enterChat;
  gateUsername.addEventListener('keypress', e => { if(e.key === 'Enter') enterChat(); });

  // initially disable composer until name is set
  input.disabled = true;
  sendBtn.disabled = true;

  sendBtn.onclick = sendMessage;
  input.addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });
  saveUsername.onclick = () => {
    const val = usernameInput.value.trim();
    if(!val) return;
    socket.emit('user:set_username', val);
  };

  // admin UI actions
  familyToggle?.addEventListener('change', () => {
    socket.emit('admin:set_family_friendly', familyToggle.checked);
  });
  kickBtn?.addEventListener('click', () => {
    const userId = userSelect.value;
    const durationMs = Number(banDuration.value || 0);
    if(userId) socket.emit('admin:kick', { userId, durationMs });
  });
  loadHistoryBtn?.addEventListener('click', () => {
    socket.emit('admin:get_history', { limit: 200 });
  });

  function refreshPresence(users){
    // dropdown
    if(userSelect){
      userSelect.innerHTML = '';
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id; opt.textContent = u.username; opt.style.color = u.color;
        userSelect.appendChild(opt);
      });
    }
    // list
    if(userList){
      userList.innerHTML = '';
      users.forEach(u => addPresenceEntry(u));
    }
  }
  function addOrUpdatePresence(u){
    if(userSelect){
      const opt = [...userSelect.options].find(o => o.value === u.id);
      if(!opt){
        const n = document.createElement('option'); n.value = u.id; n.textContent = u.username; n.style.color = u.color; userSelect.appendChild(n);
      } else {
        opt.textContent = u.username; opt.style.color = u.color;
      }
    }
    addPresenceEntry(u);
  }
  function addPresenceEntry(u){
    if(!userList) return;
    let row = userList.querySelector(`[data-id="${u.id}"]`);
    if(!row){
      row = document.createElement('div');
      row.dataset.id = u.id;
      row.style.display = 'flex';
      row.style.alignItems = 'center';
      row.style.justifyContent = 'space-between';
      row.style.gap = '8px';
      row.style.padding = '6px 8px';
      row.style.border = '1px solid rgba(255,255,255,.06)';
      row.style.borderRadius = '8px';
      userList.appendChild(row);
    }
    row.innerHTML = '';
    const left = document.createElement('div');
    left.style.display = 'flex';
    left.style.alignItems = 'center';
    left.style.gap = '8px';
    const swatch = document.createElement('div'); swatch.style.width='10px'; swatch.style.height='10px'; swatch.style.borderRadius='999px'; swatch.style.background=u.color;
    const name = document.createElement('div'); name.textContent = u.username; name.style.fontSize = '13px';
    if(u.isAdmin){ const b = document.createElement('span'); b.className='badge admin'; b.textContent='admin'; name.appendChild(b); }
    left.appendChild(swatch); left.appendChild(name);
    const right = document.createElement('div');
    const kick = document.createElement('button'); kick.className='linklike'; kick.textContent='Kick'; kick.onclick = () => { if(userSelect){ userSelect.value = u.id; } if(kickBtn){ kickBtn.click(); } };
    right.appendChild(kick);
    row.appendChild(left); row.appendChild(right);
  }
  function removePresence(id){
    if(userSelect){
      const opt = [...userSelect.options].find(o => o.value === id);
      if(opt) opt.remove();
    }
    if(userList){
      const row = userList.querySelector(`[data-id="${id}"]`);
      if(row) row.remove();
    }
  }

  // socket events
  socket.on('init', (payload) => {
    setSelf(payload.self);
    usernameInput.value = payload.self.username || '';
    renderAll(payload.messages || []);
    // admin and presence state
    if(adminSection) adminSection.style.display = payload.self.isAdmin ? 'block' : 'none';
    if(familyToggle) familyToggle.checked = !!payload.familyFriendly;
    if(payload.users) refreshPresence(payload.users);
  });
  socket.on('user:update_self', (payload) => {
    setSelf(payload);
    if(adminSection) adminSection.style.display = payload.isAdmin ? 'block' : 'none';
  });
  socket.on('chat:new', (m) => {
    appendOne(m);
  });
  socket.on('chat:edited', ({ id, text, editedAt }) => {
    const node = [...messagesEl.children].find(n => n.dataset.id === id);
    if(!node) return;
    const textEl = node.querySelector('.text');
    if(textEl){ textEl.textContent = text; }
    const meta = node.querySelector('.meta');
    if(meta){
      const tag = document.createElement('span');
      tag.textContent = ' (edited)';
      tag.style.opacity = .7;
      meta.appendChild(tag);
    }
  });
  socket.on('chat:deleted', ({ id }) => {
    const node = [...messagesEl.children].find(n => n.dataset.id === id);
    if(node) node.remove();
  });
  socket.on('presence:join', (u) => addOrUpdatePresence(u));
  socket.on('presence:update', (u) => addOrUpdatePresence(u));
  socket.on('presence:leave', ({ id }) => removePresence(id));
  socket.on('admin:family_friendly', ({ enabled }) => { if(familyToggle) familyToggle.checked = !!enabled; });
  socket.on('admin:history', (arr) => {
    messagesEl.innerHTML = '';
    renderAll(arr);
  });
  socket.on('sys:kicked', ({ reason }) => {
    alert(reason || 'Kicked');
  });
</script>
</body>
</html>
